name: Hourly Surf Update

on:
  schedule:
    - cron: "5 * * * *"
  workflow_dispatch:

concurrency:
  group: hourly-surf-update
  cancel-in-progress: false

jobs:
  trigger-update:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Trigger production update API
        env:
          WAVES_CRON_SECRET: ${{ secrets.WAVES_CRON_SECRET }}
          WAVES_CRON_URL: ${{ secrets.WAVES_CRON_URL }}
        run: |
          set -euo pipefail

          CRON_URL="${WAVES_CRON_URL:-https://waves-three-theta.vercel.app/api/cron/update}"

          if [ -z "${WAVES_CRON_SECRET:-}" ]; then
            echo "Missing GitHub secret: WAVES_CRON_SECRET"
            exit 1
          fi

          response_file="$(mktemp)"
          http_status=$(curl -sS -o "$response_file" -w "%{http_code}" \
            -H "Authorization: Bearer ${WAVES_CRON_SECRET}" \
            "$CRON_URL")

          cat "$response_file"
          echo

          if [ "$http_status" -lt 200 ] || [ "$http_status" -ge 300 ]; then
            echo "Update request failed with HTTP status: $http_status"
            exit 1
          fi

          node -e '
          const fs = require("node:fs");
          const path = process.argv[1];
          const data = JSON.parse(fs.readFileSync(path, "utf8"));
          if (!data.ok) {
            console.error("Update response ok=false");
            process.exit(1);
          }
          ' "$response_file"

          echo "Hourly update succeeded."
